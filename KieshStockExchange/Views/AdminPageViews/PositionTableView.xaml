<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KieshStockExchange.ViewModels.AdminViewModels"
             x:Class="KieshStockExchange.Views.AdminPageViews.PositionTableView" 
             x:Name="PositionTableRoot" >
    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Labels -->
        <Grid ColumnDefinitions="60, 95, *, *, 2*, 2*, 2.5*, 60, 3" 
              Style="{StaticResource TableHeaderGrid}" RowDefinitions="Auto,Auto" >
            <Label Text="UserId" Grid.Column="0" 
                   Style="{StaticResource TableHeaderLabel}"/>
            <Label Text="Stock" Grid.Column="1" 
                   Style="{StaticResource TableHeaderLabel}"/>
            <Label Text="Quantity" Grid.Column="2" 
                   Style="{StaticResource TableHeaderLabel}" />
            <Label Text="Reserved" Grid.Column="3" 
                   Style="{StaticResource TableHeaderLabel}" />
            <Label Text="Price" Grid.Column="4" 
                   Style="{StaticResource TableHeaderLabel}" />
            <Label Text="Pos Value" Grid.Column="5" 
                   Style="{StaticResource TableHeaderLabel}" />
            <Label Text="Total Value" Grid.Column="6" 
                   Style="{StaticResource TableHeaderLabel}" />
            <Label Text="Edit" Grid.Column="7" 
                   Style="{StaticResource TableHeaderLabel}" />
            
            <!-- Filters and Sorting -->
            <Entry Grid.Row="1" Grid.Column="0" Placeholder="Type ID…"
                   Text="{Binding IdFilter, Mode=TwoWay}" Keyboard="Numeric"/>
            <Picker ItemsSource="{Binding PickerStocks}" Grid.Column="1" 
                    ItemDisplayBinding="{Binding Symbol}" Grid.Row="1"
                    SelectedItem="{Binding PickerSelection, Mode=TwoWay}" />
            <HorizontalStackLayout Grid.Row="1" Grid.Column="2" Style="{StaticResource SortingStackLayout}">
                <Button Text="↓" Command="{Binding SetSortDescCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Quantity}" />
                <Button Text="↑" Command="{Binding SetSortAscCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Quantity}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Grid.Row="1" Grid.Column="3" Style="{StaticResource SortingStackLayout}">
                <Button Text="↓" Command="{Binding SetSortDescCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Reserved}" />
                <Button Text="↑" Command="{Binding SetSortAscCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Reserved}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Grid.Row="1" Grid.Column="4" Style="{StaticResource SortingStackLayout}">
                <Button Text="↓" Command="{Binding SetSortDescCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Price}" />
                <Button Text="↑" Command="{Binding SetSortAscCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.Price}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Grid.Row="1" Grid.Column="5" Style="{StaticResource SortingStackLayout}">
                <Button Text="↓" Command="{Binding SetSortDescCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.StockValue}" />
                <Button Text="↑" Command="{Binding SetSortAscCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.StockValue}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Grid.Row="1" Grid.Column="6" Style="{StaticResource SortingStackLayout}">
                <Button Text="↓" Command="{Binding SetSortDescCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.TotalValue}" />
                <Button Text="↑" Command="{Binding SetSortAscCommand}"
                        Style="{StaticResource TableSortingButton}"
                        CommandParameter="{x:Static vm:PosSortColumn.TotalValue}" />
            </HorizontalStackLayout>
        </Grid>

        <!-- CollectionView for displaying user data -->
        <CollectionView ItemsSource="{Binding PagedItems}" Margin="10" Grid.Row="1" >
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:PositionTableObject">
                    <Grid ColumnDefinitions="60, 95, *, *, 2*, 2*, 2.5*, 60, 3" 
                          Style="{StaticResource TableRowGrid}">
                        <!-- Viewing Mode Labels -->
                        <Label Text="{Binding UserId}" Grid.Column="0" 
                               Style="{StaticResource TableRowLabel}" />
                        <Label Text="{Binding StockSymbol}" Grid.Column="1" 
                               Style="{StaticResource TableRowLabel}" />
                        <Label Text="{Binding QuantityDisplay}" Grid.Column="2" 
                               Style="{StaticResource TableRowLabel}" 
                               IsVisible="{Binding IsViewing}" />
                        <Label Text="{Binding ReservedQuantityDisplay}" Grid.Column="3" 
                               Style="{StaticResource TableRowLabel}" 
                               IsVisible="{Binding IsViewing}" />
                        <Label Text="{Binding PriceDisplay}" Grid.Column="4" 
                               Style="{StaticResource TableRowLabel}" />
                        <Label Text="{Binding StockValueDisplay}" Grid.Column="5" 
                               Style="{StaticResource TableRowLabel}" />
                        <Label Text="{Binding TotalValueDisplay}" Grid.Column="6"
                               Style="{StaticResource TableRowLabel}" />
                        <Label Text="{Binding EditText}" Grid.Column="7"
                               Style="{StaticResource TableEditLabel}" >
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ChangeEditCommand}" NumberOfTapsRequired="1" />
                            </Label.GestureRecognizers>
                        </Label>

                        <!-- Editing Mode Entries -->
                        <Entry Text="{Binding QuantityDisplay, Mode=TwoWay}" Grid.Column="2" 
                               Style="{StaticResource TableRowEntry}" 
                               IsVisible="{Binding IsEditing}" />
                        <Entry Text="{Binding ReservedQuantityDisplay, Mode=TwoWay}" Grid.Column="3" 
                               Style="{StaticResource TableRowEntry}" 
                               IsVisible="{Binding IsEditing}" />

                        <!-- Vertical Lines -->
                        <BoxView Grid.Column="0" Style="{StaticResource TableVerticalSeparator}"/>
                        <BoxView Grid.Column="1" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="2" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="3" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="4" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="5" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="6" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="7" Style="{StaticResource TableVerticalSeparator}" />
                        <BoxView Grid.Column="8" Style="{StaticResource TableVerticalSeparator}" />

                        <!-- Horizontal line (bottom of the row) -->
                        <BoxView Style="{StaticResource TableHorizontalSeparator}" />
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Table Page Navigation -->
        <HorizontalStackLayout Style="{StaticResource PageNumberStackLayout}" Grid.Row="2" 
                    BindableLayout.ItemsSource="{Binding VisiblePageNumbers}" >
            <BindableLayout.ItemTemplate>
                <DataTemplate>
                    <Button Text="{Binding .}"
                            Command="{Binding Source={x:Reference PositionTableRoot}, 
                            Path=BindingContext.GoToPageCommand}"
                            CommandParameter="{Binding .}"
                            Style="{StaticResource PageNumberButton}"/>
                </DataTemplate>
            </BindableLayout.ItemTemplate>
        </HorizontalStackLayout>
    </Grid>
</ContentView>
